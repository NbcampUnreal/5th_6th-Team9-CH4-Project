# 인벤토리 & 아이템 시스템 설계서
## 언리얼 엔진 5 C++ 멀티플레이어 보드게임

---

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [아이템 데이터 구조](#2-아이템-데이터-구조)
3. [아이템 목록](#3-아이템-목록)
4. [조작 방식](#4-조작-방식)
5. [인벤토리 시스템](#5-인벤토리-시스템)
6. [버프/디버프 시스템](#6-버프디버프-시스템)
7. [네트워크 동기화](#7-네트워크-동기화)
8. [게임 규칙 연동](#8-게임-규칙-연동)
9. [UI 구조](#9-ui-구조)
10. [클래스 구조](#10-클래스-구조)
11. [구현 우선순위](#11-구현-우선순위)

---

## 1. 시스템 개요

### 핵심 규칙
| 항목 | 내용 |
|------|------|
| 인벤토리 슬롯 | 5칸 |
| 스택 | 불가능 (1슬롯 = 1아이템) |
| 턴당 사용 | 1회만 |
| 사용 시점 | 자기 턴, 주사위 굴리기 전 |
| 조작 시간제한 | 30초 (Instant 타입 제외) |
| 취소 | ESC 키 |

### 아이템 획득 방법
- 특정 타일 도착 시 자동 획득
- 미니게임 보상
- 상점에서 구매

---

## 2. 아이템 데이터 구조

### 아이템 분류
```
카테고리 (EItemCategory)
├── Attack    : 공격 아이템
├── Buff      : 버프 아이템
└── Movement  : 이동 아이템

조작 타입 (EItemUseType)
├── Instant       : 즉시 발동
├── MouseAim      : 마우스 조준 → 좌클릭
├── TileTarget    : A/D 타일 순회 → Space
└── DirectControl : WASD 이동 조작 → Space
```

### 데이터 필드
| 필드명 | 타입 | 설명 |
|--------|------|------|
| ItemID | FName | 아이템 고유 ID |
| ItemName | FText | 아이템 이름 |
| Description | FText | 아이템 설명 |
| Icon | UTexture2D* | 아이템 아이콘 |
| Category | EItemCategory | 카테고리 |
| UseType | EItemUseType | 조작 타입 |
| DropWeight | float | 드롭 확률 가중치 |
| OperationTimeLimit | float | 조작 제한시간 (기본 30초) |
| EffectClass | TSubclassOf | 효과 클래스 |

---

## 3. 아이템 목록

### 공격 아이템 (4개)

| 이름 | ID | 조작 타입 | 효과 |
|------|-----|-----------|------|
| **샷건** | Shotgun | MouseAim | 마우스 방향으로 부채꼴 다중 총알 발사, 총알당 10 데미지 |
| **야구방망이** | BaseballBat | MouseAim | 마우스 방향 1칸 내 모든 플레이어에게 50 데미지 |
| **RC카** | RCCar | DirectControl | RC카 소환 후 WASD로 30초간 조작, Space로 폭발, 1칸 원형 범위 50 데미지 |
| **벌꿀집** | Beehive | TileTarget | 선택한 타일에 있는 모든 플레이어에게 30 데미지 |

### 버프 아이템 (1개)

| 이름 | ID | 조작 타입 | 효과 |
|------|-----|-----------|------|
| **실드** | Shield | Instant | 피해 1회 완전 무효화 (라운드 무관, 피격 시 소멸) |

### 이동 아이템 (2개)

| 이름 | ID | 조작 타입 | 효과 |
|------|-----|-----------|------|
| **순간이동기** | Teleporter | TileTarget | 맵 전체 중 원하는 타일로 이동 |
| **망가진 순간이동기** | BrokenTeleporter | Instant | 랜덤 타일로 즉시 이동 |

---

## 4. 조작 방식

### 4가지 조작 패턴

#### Instant (즉시 발동)
```
아이템 선택 → 즉시 효과 적용
```
- 시간제한: 없음
- 해당 아이템: 실드, 망가진 순간이동기

#### MouseAim (마우스 조준)
```
아이템 선택 → 마우스로 조준 → 좌클릭으로 발동
```
- 시간제한: 30초
- 취소: ESC
- 해당 아이템: 샷건, 야구방망이
- 다른 플레이어에게 조준 방향 실시간 공유

#### TileTarget (타일 선택)
```
아이템 선택 → A/D로 타일 순회 → Space로 확정
```
- 시간제한: 30초
- 취소: ESC
- 해당 아이템: 순간이동기, 벌꿀집
- 선택 가능 범위: 맵 전체
- 현재 선택된 타일 하이라이트 표시

#### DirectControl (직접 조작)
```
아이템 선택 → 오브젝트 소환 → WASD로 이동 → Space로 발동
```
- 시간제한: 30초
- 취소: ESC
- 해당 아이템: RC카
- 카메라가 조작 대상을 따라감
- 시간 초과 시 현재 위치에서 자동 발동

---

## 5. 인벤토리 시스템

### 슬롯 구조
```
┌─────┬─────┬─────┬─────┬─────┐
│  1  │  2  │  3  │  4  │  5  │
└─────┴─────┴─────┴─────┴─────┘
  위치: 화면 좌측 하단
  입력: 좌클릭 또는 키보드 1~5
```

### 인벤토리 조작

| 동작 | 방법 |
|------|------|
| 아이템 사용 | 슬롯 클릭 또는 1~5 키 |
| 슬롯 정렬 | 드래그 앤 드롭 |
| 자발적 버리기 | 불가능 |

### 인벤토리 풀 처리
```
인벤토리 가득 참 + 새 아이템 획득
           ↓
    ┌─────────────────────────┐
    │  새 아이템: [아이콘]      │
    │                         │
    │  [버리기 버튼]           │
    │                         │
    │  현재 인벤토리:          │
    │  [1] [2] [3] [4] [5]    │
    │  (클릭 시 교체)          │
    └─────────────────────────┘
```
- 새 아이템 버리기: 버리기 버튼 클릭
- 기존 아이템과 교체: 교체할 슬롯 클릭

### 레벨 간 데이터 유지
- GameInstance를 통해 인벤토리 데이터 저장
- 레벨 전환 시에도 아이템 유지

---

## 6. 버프/디버프 시스템

### 효과 종료 조건 2가지

#### 라운드 기반 (RoundBased)
- 모든 플레이어가 1턴씩 = 1라운드
- N라운드 후 효과 종료
- 같은 효과 중첩 시 **시간 누적** (2라운드 + 2라운드 = 4라운드)

#### 횟수 기반 (CountBased)
- N회 발동 후 효과 종료
- 예: 실드 (1회 피격 방어 후 소멸)

### 효과 규칙
| 항목 | 내용 |
|------|------|
| 중첩 방식 | 같은 효과 = 시간 누적 |
| 동시 효과 | 제한 없음 (여러 버프/디버프 동시 적용 가능) |
| 실드 특성 | 라운드 무관, 피해 1회 완전 무효화 |

---

## 7. 네트워크 동기화

### 기본 흐름
```
[클라이언트]                    [서버]                     [모든 클라이언트]
     │                           │                              │
     │ 아이템 선택               │                              │
     │ 조작 시작                 │                              │
     │─────조작 상태 전송────────→│                              │
     │                           │─────조작 상태 브로드캐스트────→│
     │                           │                              │ (조준선, 위치 표시)
     │ 확정 (좌클릭/Space)       │                              │
     │─────사용 요청─────────────→│                              │
     │                           │ 검증:                        │
     │                           │ - 턴 체크                    │
     │                           │ - 아이템 보유 체크           │
     │                           │ - 턴당 1회 체크              │
     │                           │ - 범위/유효성 체크           │
     │                           │                              │
     │                           │ 효과 적용                    │
     │                           │─────결과 브로드캐스트────────→│
     │                           │                              │ (이펙트, 사운드, UI)
```

### 서버 검증 항목 (중간 수준)

#### 기본 검증
- 현재 이 플레이어의 턴인가?
- 해당 아이템을 보유하고 있는가?
- 이번 턴에 이미 아이템을 사용했는가?

#### 범위/유효성 검증
- TileTarget: 선택한 타일이 맵에 존재하는가?
- MouseAim: 조준 방향이 유효한가?
- DirectControl: 최종 위치가 맵 범위 내인가?
- 피해 대상이 실제로 해당 위치에 있는가?

### 동기화 대상

| 항목 | 동기화 방식 |
|------|-------------|
| 인벤토리 슬롯 | Replicated (변경 시 자동 동기화) |
| 활성 효과 | Replicated |
| 조작 중 상태 | 실시간 브로드캐스트 |
| 아이템 사용 결과 | Multicast RPC |
| 이펙트/사운드 | 모든 클라이언트에서 재생 |

---

## 8. 게임 규칙 연동

### 플레이어 스탯
| 스탯 | 설명 |
|------|------|
| HP | 체력, 0이 되면 사망 처리 |
| Coins | 코인, 사망 시 30% 손실 |
| MaxHP | 최대 체력, 사망 후 회복 기준 |

### HP 0 처리 (사망)
```
HP가 0이 됨
    ↓
코인 30% 손실
    ↓
무인도 타일로 이동
    ↓
HP 풀 회복 (MaxHP로)
    ↓
다음 턴 정상 진행
```

### 실드와 피해 상호작용
```
실드 보유 상태에서 피해 받음
    ↓
실드 발동 → 모든 피해 무효화
    ↓
실드 소멸 (1회용)
```

### HP 회복 방법
- 회복 타일 도착 시 HP 회복
- 현재 회복 아이템은 없음

### 턴 흐름
```
[턴 시작]
    ↓
┌───────────────────────────────┐
│ [아이템 슬롯 1~5]    [주사위]  │ ← 둘 다 활성화
└───────────────────────────────┘
    │
    ├─ 아이템 클릭 → 아이템 사용 → 아이템 비활성화
    │                           → 주사위만 남음
    │
    └─ 주사위 클릭 → 아이템 단계 스킵
    │
    ↓
[주사위 굴리기 → 이동 → 타일 효과 → 턴 종료]
```

---

## 9. UI 구조

### 위젯 계층
```
WBP_HUD (메인 HUD)
├── WBP_Inventory (인벤토리)
│   ├── WBP_InventorySlot x 5 (슬롯)
│   └── 드래그 앤 드롭 처리
│
├── WBP_ItemOperation (아이템 조작 중)
│   ├── 타이머 (30초 카운트다운)
│   ├── 취소 안내 ("ESC로 취소")
│   └── 타입별 UI
│       ├── MouseAim: 크로스헤어
│       ├── TileTarget: 타일명, A/D 안내
│       └── DirectControl: WASD 안내
│
└── WBP_InventoryFull (인벤토리 풀 팝업)
    ├── 새 아이템 정보
    ├── 버리기 버튼
    └── 현재 슬롯 5개 (클릭 시 교체)
```

### 인벤토리 슬롯 위젯
```
┌─────────────┐
│   [아이콘]   │
│             │
│   빈 슬롯   │ ← 아이템 없을 때
└─────────────┘

┌─────────────┐
│   🔥        │
│             │
│   샷건      │ ← 아이템 있을 때 (호버 시 이름 표시)
└─────────────┘
```

---

## 10. 클래스 구조

### 핵심 클래스

```
UInventoryComponent (ActorComponent)
├── 인벤토리 슬롯 관리 (5칸)
├── 활성 효과 관리 (버프/디버프)
├── 아이템 추가/제거/교환
├── 네트워크 Replication
└── 턴당 사용 제한 체크

UItemEffectBase (UObject, Abstract)
├── StartUse()      : 사용 시작
├── TickUse()       : 매 프레임 업데이트
├── ExecuteEffect() : 효과 발동
├── CancelUse()     : 취소
└── GetUseType()    : 조작 타입 반환

UItemEffect_Instant     : 즉시 발동
UItemEffect_MouseAim    : 마우스 조준
UItemEffect_TileTarget  : 타일 선택
UItemEffect_DirectControl : 직접 조작
```

### 구체적 아이템 효과 클래스
```
Effects/Concrete/
├── UEffect_Shotgun.cpp
├── UEffect_BaseballBat.cpp
├── UEffect_RCCar.cpp
├── UEffect_Beehive.cpp
├── UEffect_Shield.cpp
├── UEffect_Teleporter.cpp
└── UEffect_BrokenTeleporter.cpp
```

### 폴더 구조
```
Source/BoardGame/
├── Items/
│   ├── Data/
│   │   ├── ItemTypes.h
│   │   ├── ItemData.h
│   │   └── ItemUseContext.h
│   │
│   ├── Effects/
│   │   ├── ItemEffectBase.h/.cpp
│   │   ├── ItemEffect_Instant.h/.cpp
│   │   ├── ItemEffect_MouseAim.h/.cpp
│   │   ├── ItemEffect_TileTarget.h/.cpp
│   │   ├── ItemEffect_DirectControl.h/.cpp
│   │   └── Concrete/
│   │
│   └── ItemSubsystem.h/.cpp
│
├── Inventory/
│   ├── InventoryComponent.h/.cpp
│   └── InventoryTypes.h
│
├── UI/Inventory/
│   ├── InventoryWidget.h/.cpp
│   ├── InventorySlotWidget.h/.cpp
│   ├── ItemOperationWidget.h/.cpp
│   └── InventoryFullWidget.h/.cpp
│
└── Core/
    └── BoardGameInstance.h/.cpp
```

---

## 11. 구현 우선순위

### Phase 1: 기반 구축 (1주차)
- [ ] 열거형, 구조체 정의
- [ ] DataTable 생성 및 7개 아이템 데이터 입력
- [ ] UInventoryComponent 기본 구현 (로컬)
- [ ] 인벤토리 UI 기본 구현 (5슬롯 표시)

### Phase 2: 아이템 효과 (2주차)
- [ ] UItemEffectBase 베이스 클래스
- [ ] UItemEffect_Instant 구현
- [ ] 실드, 망가진 순간이동기 구현
- [ ] 로컬 테스트

### Phase 3: 조작 타입 (3주차)
- [ ] UItemEffect_MouseAim 구현
- [ ] UItemEffect_TileTarget 구현
- [ ] UItemEffect_DirectControl 구현
- [ ] 30초 타이머, ESC 취소
- [ ] 조작 UI 위젯

### Phase 4: 네트워크 (4주차)
- [ ] InventoryComponent Replication
- [ ] ServerRPC 아이템 사용 요청
- [ ] Multicast 결과 전파
- [ ] 조작 상태 실시간 동기화
- [ ] 서버 검증 로직

### Phase 5: 마무리 (5주차)
- [ ] 버프/디버프 시스템 (라운드 추적)
- [ ] 인벤토리 풀 UI 및 교체 로직
- [ ] 드래그 앤 드롭 슬롯 정렬
- [ ] GameInstance 데이터 유지
- [ ] 7개 아이템 효과 전체 구현
- [ ] 이펙트, 사운드

---

## 주의사항

1. **실드는 횟수 기반** - 라운드와 무관하게 1회 피해 방어
2. **효과 중첩 = 시간 누적** - 같은 버프 사용 시 지속시간 추가
3. **벌꿀집은 타일 대상** - 플레이어가 아닌 타일을 선택
4. **RC카는 카메라 전환** - 조작 중 카메라가 RC카를 따라감
5. **자발적 아이템 버리기 불가** - 사용하거나 풀일 때 교체만 가능
6. **무인도에 갇힘 없음** - 사망 후 이동 위치일 뿐, 다음 턴 정상 진행
7. **HP 회복은 타일만** - 현재 회복 아이템 없음
